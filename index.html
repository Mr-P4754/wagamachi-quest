<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ãŒã¾ã¡ã‚¯ã‚¨ã‚¹ãƒˆ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;800&display=swap" rel="stylesheet">

    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body { margin: 0; padding: 0; font-family: 'M PLUS Rounded 1c', sans-serif; background: #fafafa; overflow: hidden; }
        .screen { display: none; width: 100%; height: 100vh; position: absolute; top: 0; left: 0; background: #fff; }
        .active-screen { display: block; }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        #loading-overlay {
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #ccc; border-top: 5px solid #3498db;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
        #title-screen {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        h1 { color: #d35400; font-size: 36px; text-shadow: 3px 3px 0px white; margin-bottom: 30px; line-height: 1.2; }
        .menu-btn {
            width: 240px; padding: 15px; margin: 10px; font-size: 20px; font-weight: bold; color: white;
            border: 4px solid white; border-radius: 30px; box-shadow: 0 5px 10px rgba(0,0,0,0.2); cursor: pointer;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); user-select: none;
        }
        .menu-btn:active { transform: scale(0.95); }
        .btn-play { background: #ff9f43; padding: 20px; font-size: 24px; }
        .btn-collection { background: #1dd1a1; }
        .btn-cloud { background: #9b59b6; }
        .btn-admin { background: #8395a7; font-size: 16px; margin-top: 30px; }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #map { height: 100%; width: 100%; }
        body.mode-editor #map-container { border: 8px solid #FF9800; box-sizing: border-box; }
        body.mode-admin #map-container { border: 8px solid #e74c3c; box-sizing: border-box; }
        
        .ui-float { position: absolute; z-index: 1000; font-weight: bold; text-shadow: 1px 1px 0 #fff; user-select: none; }
        #back-btn { top: 15px; left: 70px; background: white; padding: 8px 15px; border-radius: 20px; border: 2px solid #ccc; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #score-board { top: 15px; right: 15px; background: #FFD700; color: #d35400; padding: 8px 15px; border-radius: 20px; border: 3px solid white; box-shadow: 0 3px 5px rgba(0,0,0,0.2); }
        
        #jump-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000; background: white; padding: 10px 20px;
            border-radius: 30px; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center;
            font-size: 16px; font-weight: bold; color: #333; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        #jump-btn:active { background: #eee; transform: scale(0.95); }
        #jump-btn.tracking { background: #e3f2fd; border-color: #2196f3; color: #2196f3; }

        #checkin-btn {
            display: none; position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 2000;
            background: #ff5252; color: white; padding: 15px 40px; font-size: 22px; border-radius: 50px;
            border: 4px solid white; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); animation: bounce 1s infinite; cursor: pointer; font-weight: bold;
        }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); } }

        /* ãšã‹ã‚“ç”»é¢ */
        #collection-screen { background: #f0f3f5; overflow-y: auto; }
        #collection-header {
            background: #1dd1a1; color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header-title { font-size: 22px; margin-bottom: 5px; }
        .header-score { font-size: 16px; background: rgba(255,255,255,0.2); display: inline-block; padding: 5px 15px; border-radius: 15px; }
        #collection-list { padding: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .collection-item {
            background: white; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1); cursor: pointer; border: 2px solid #fff; transition: transform 0.1s;
        }
        .collection-item:active { transform: scale(0.98); }
        .collection-item img { width: 100%; height: 120px; object-fit: cover; border-radius: 10px; background: #eee; margin-bottom: 8px; }
        .item-name { font-size: 14px; font-weight: bold; color: #333; text-align: center; line-height: 1.4; width: 100%; word-wrap: break-word; }
        .back-home-btn { 
            position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: white; color: #1dd1a1; border: none; padding: 5px 12px;
            border-radius: 20px; font-size: 14px; cursor: pointer; font-weight:bold;
        }

        /* ã‚¯ãƒ©ã‚¦ãƒ‰ç”»é¢ */
        #cloud-screen { background: #9b59b6; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .cloud-box { background: white; padding: 20px; border-radius: 20px; width: 85%; max-width: 400px; color: #333; text-align: center; }
        .cloud-input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #ccc; border-radius: 8px; box-sizing: border-box; }

        /* å…±é€šï¼šãƒ¢ãƒ€ãƒ« */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; padding: 20px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center;
            border: 5px solid #3498db; max-height: 85vh; overflow-y: auto; position: relative;
        }
        
        /* ã‚«ãƒ«ãƒ¼ã‚»ãƒ« */
        .carousel-container { position: relative; width: 100%; height: 220px; margin-bottom: 10px; border-radius: 10px; overflow: hidden; background: #ddd; }
        .carousel-img { width: 100%; height: 100%; object-fit: cover; }
        .carousel-btn {
            position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none;
            width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .prev-btn { left: 10px; }
        .next-btn { right: 10px; }
        .carousel-counter { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; }

        /* ã‚¿ã‚° */
        .tags-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-bottom: 10px; }
        .tag-badge { background: #e3f2fd; color: #1565c0; font-size: 12px; font-weight: bold; padding: 4px 10px; border-radius: 15px; border: 1px solid #bbdefb; }

        .spot-desc-lg { text-align: left; background: #f9f9f9; padding: 10px; border-radius: 8px; color: #333; margin-bottom: 15px; font-size: 14px; line-height: 1.6; }
        
        /* UIè¦ç´  */
        .input-group { margin-bottom: 10px; text-align: left; }
        .input-group label { font-size: 12px; color: #555; display: block; margin-bottom: 4px; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 8px; border: 2px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: bold; color: white; margin: 5px; cursor: pointer; }
        .btn-blue { background: #3498db; } .btn-red { background: #ff5252; } .btn-gray { background: #7f8c8d; } .btn-orange { background: #f39c12; } .btn-green { background: #27ae60; }
        .hint-text { font-size: 11px; color: #d35400; text-align: left; margin-top: -5px; margin-bottom: 10px; }

        /* ã‚¯ã‚¤ã‚ºç”¨UI */
        .quiz-choice-btn {
            width: 100%; padding: 15px; margin: 5px 0; background: #fff; border: 2px solid #3498db;
            color: #3498db; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;
        }
        .quiz-choice-btn:active { background: #e3f2fd; transform: scale(0.98); }
        .quiz-choice-btn:disabled { background: #eee; border-color: #ccc; color: #999; cursor: default; }

        /* ã‚¯ã‚¤ã‚ºç®¡ç†ãƒªã‚¹ãƒˆ */
        .quiz-list-item {
            background: #eee; padding: 10px; margin-bottom: 5px; border-radius: 8px; text-align: left; font-size: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .quiz-list-item span { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 5px; }
        .quiz-action-btn { padding: 3px 8px; font-size: 10px; margin-left: 2px; border: none; border-radius: 4px; color: white; cursor: pointer; }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...<br>ï¼ˆåˆå›ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰</div>
    </div>

    <div id="title-screen" class="screen active-screen">
        <h1>ã‚ãŒã¾ã¡<br>ã‚¯ã‚¨ã‚¹ãƒˆ</h1>
        <div class="menu-btn btn-play" onclick="startGame('player')">å†’é™ºã«å‡ºã‚‹</div>
        <div class="menu-btn btn-collection" onclick="showCollection()">ãšã‹ã‚“ã‚’è¦‹ã‚‹</div>
        <div class="menu-btn btn-cloud" onclick="showCloudScreen()">ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜/èª­è¾¼</div>
        <div class="menu-btn btn-admin" onclick="requestAdminLogin()">è¨­å®šãƒ»ç·¨é›†</div>
    </div>

    <div id="game-screen" class="screen">
        <div id="map-container" style="width:100%; height:100%;">
            <div id="map"></div>
        </div>
        <div id="back-btn" class="ui-float" onclick="goTitle()">ğŸ  ã‚‚ã©ã‚‹</div>
        <div id="score-board" class="ui-float">â˜… <span id="score-val">0</span></div>
        <div id="jump-btn" class="tracking" onclick="jumpToUser()">ç¾åœ¨åœ°ã¸</div>
        <button id="checkin-btn" onclick="openCheckinModal()">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼</button>
    </div>

    <div id="collection-screen" class="screen">
        <div id="collection-header">
            <button class="back-home-btn" onclick="goTitle()">ğŸ </button>
            <div class="header-title">ç™ºè¦‹ã—ãŸã‚¹ãƒãƒƒãƒˆ</div>
            <div class="header-score">ç¾åœ¨ã®ã‚¹ã‚³ã‚¢: <span id="collection-score-val">0</span> pt</div>
        </div>
        <div id="collection-list"></div>
    </div>

    <div id="cloud-screen" class="screen">
        <div class="cloud-box">
            <h2>ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h2>
            <p>ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
            <input type="email" id="cloud-email" class="cloud-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
            <input type="password" id="cloud-pass" class="cloud-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆè‡ªç”±è¨­å®šï¼‰">
            <button class="btn btn-orange" onclick="cloudSave()">ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹</button>
            <button class="btn btn-green" onclick="cloudLoad()">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
            <hr><button class="btn btn-gray" onclick="goTitle()">æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="detail-modal" class="modal-overlay">
        <div class="modal-box" id="detail-box-border">
            <h2 id="det-title" style="margin-top:0; color:#e67e22;"></h2>
            <div id="det-tags" class="tags-container"></div>

            <div class="carousel-container">
                <img id="det-img" class="carousel-img" src="" referrerpolicy="no-referrer">
                <button class="carousel-btn prev-btn" onclick="changeSlide(-1)">â®</button>
                <button class="carousel-btn next-btn" onclick="changeSlide(1)">â¯</button>
                <div id="det-img-count" class="carousel-counter">1/1</div>
            </div>

            <div id="det-desc" class="spot-desc-lg"></div>
            <div id="reward-msg" style="display:none; color:#d35400; font-weight:bold; font-size:18px; margin-bottom:10px;">+50ãƒã‚¤ãƒ³ãƒˆ GET!</div>
            
            <button id="btn-challenge-quiz" class="btn btn-green" style="display:none;" onclick="startQuiz()">Q. ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ï¼</button>
            
            <button id="btn-edit-spot" class="btn btn-orange" style="display:none;" onclick="triggerEditFromDetail()">âœ ç·¨é›†ã™ã‚‹</button>
            <button class="btn btn-blue" onclick="closeModal('detail-modal')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="quiz-play-modal" class="modal-overlay">
        <div class="modal-box" style="border-color:#27ae60;">
            <h3 style="color:#27ae60;">ã‚¯ã‚¤ã‚ºï¼</h3>
            <p id="qp-question" style="font-weight:bold; font-size:18px; margin:20px 0;"></p>
            <div id="qp-choices"></div>
            <div id="qp-result" style="display:none; font-weight:bold; margin-top:10px; font-size:16px;"></div>
            
            <button id="qp-next-btn" class="btn btn-blue" style="display:none;" onclick="nextQuiz()">ã¤ãã¸</button>
            <button id="qp-retry-btn" class="btn btn-orange" style="display:none;" onclick="retryQuiz()">ã‚‚ã†ä¸€åº¦</button>
            <button id="qp-close-btn" class="btn btn-gray" style="display:none;" onclick="finishQuiz()">çµ‚äº†</button>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-box" style="border-color:#FF9800;">
            <h3>ã‚¹ãƒãƒƒãƒˆç·¨é›†</h3>
            <div class="input-group"><label>åå‰</label><input type="text" id="ed-name" placeholder="ã‚¹ãƒãƒƒãƒˆå"></div>
            <div class="input-group"><label>ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label><input type="text" id="ed-tags" placeholder="ä¾‹: å…¬åœ’, ãƒ©ãƒ³ãƒ"></div>
            <div class="input-group"><label>èª¬æ˜</label><textarea id="ed-desc" placeholder="å ´æ‰€ã®èª¬æ˜"></textarea></div>
            <div class="input-group"><label>å†™çœŸURLï¼ˆæ”¹è¡Œã§è¤‡æ•°ï¼‰</label><textarea id="ed-imgs" style="height:60px;" placeholder="https://..."></textarea></div>
            <div class="hint-text">â€»Googleãƒ‰ãƒ©ã‚¤ãƒ–ã¯ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã€ã«å…¬é–‹</div>
            
            <button class="btn btn-green" onclick="openQuizManager()">ã‚¯ã‚¤ã‚ºã®ç®¡ç†</button>
            <hr>
            <button class="btn btn-blue" onclick="saveSpot()">ä¿å­˜</button>
            <button id="del-btn" class="btn btn-red" onclick="deleteSpot()">å‰Šé™¤</button>
            <button class="btn btn-gray" onclick="closeModal('edit-modal')">ä¸­æ­¢</button>
        </div>
    </div>

    <div id="quiz-manager-modal" class="modal-overlay">
        <div class="modal-box" style="border-color:#8e44ad; max-width:500px;">
            <h3>ã‚¯ã‚¤ã‚ºã®ç®¡ç†</h3>
            <div id="qm-list" style="max-height:150px; overflow-y:auto; margin-bottom:15px; border:1px solid #ccc;"></div>
            
            <div style="background:#f9f9f9; padding:10px; border-radius:10px;">
                <div class="input-group"><label>å•é¡Œæ–‡</label><input type="text" id="qm-q"></div>
                <div class="input-group"><label>é¸æŠè‚¢1</label><input type="text" id="qm-a1"></div>
                <div class="input-group"><label>é¸æŠè‚¢2</label><input type="text" id="qm-a2"></div>
                <div class="input-group"><label>é¸æŠè‚¢3</label><input type="text" id="qm-a3"></div>
                <div class="input-group"><label>æ­£è§£ã¯ï¼Ÿ</label>
                    <select id="qm-correct">
                        <option value="0">é¸æŠè‚¢1</option>
                        <option value="1">é¸æŠè‚¢2</option>
                        <option value="2">é¸æŠè‚¢3</option>
                    </select>
                </div>
                <div style="display:flex; gap:5px; justify-content:center;">
                    <button id="qm-add-btn" class="btn btn-blue" onclick="addOrUpdateQuiz()">è¿½åŠ </button>
                    <button id="qm-cancel-btn" class="btn btn-gray" style="display:none;" onclick="resetQuizForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
            
            <button class="btn btn-gray" onclick="closeQuizManager()">æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // â˜… å…±æœ‰ã•ã‚ŒãŸURLã‚’åŸ‹ã‚è¾¼ã‚“ã§ã„ã¾ã™
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzbbeY0k5hJVdJn5HVaEMTYxOt3jTzcCSk9p8p_D8aS_TzhcIdsca4k5GTkDHCBOkif/exec";

        // --- çŠ¶æ…‹ç®¡ç† ---
        let spots = [];
        let userData = {
            visitedIds: [],
            quizHistory: {} // { spotId: completedTimestamp }
        };
        let currentRole = 'player';
        let map = null, markers = [], userMarker = null, userLat = 0, userLng = 0;
        let isTracking = true;
        let targetSpot = null;
        
        // â˜… åŠå¾„30mè¨­å®š
        const CHECKIN_RANGE = 30;

        // UIç”¨å¤‰æ•°
        let editingIndex = -1, viewingSpotIndex = -1;
        let currentSpotImages = [], currentImgIndex = 0;
        let editingSpotQuizzes = [], quizEditingIndex = -1;
        let currentQuizList = [], currentQuizIndex = 0;

        // --- é€šä¿¡å‡¦ç† (Fetch) ---
        async function callGasApi(params, isPost = false) {
            const url = isPost ? GAS_API_URL : `${GAS_API_URL}?${new URLSearchParams(params)}`;
            const options = isPost ? {
                method: 'POST',
                // CORSå¯¾ç­–ã®ãŸã‚text/plain
                body: JSON.stringify(params) 
            } : { method: 'GET' };

            try {
                const response = await fetch(url, options);
                return await response.json();
            } catch (error) {
                console.error(error);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                return null;
            }
        }

        // --- èµ·å‹•æ™‚ ---
        window.onload = async function() {
            // ãƒ­ãƒ¼ã‚«ãƒ«èª­ã¿è¾¼ã¿
            const localData = localStorage.getItem('localSaveData');
            if(localData) userData = JSON.parse(localData);
            updateScore();

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¹ãƒãƒƒãƒˆå–å¾—
            const res = await callGasApi({ action: 'getAllSpots' });
            if(res) {
                spots = res;
                document.getElementById('loading-overlay').style.display = 'none';
                updateScore();
            }
        };

        function updateScore() {
            let quizScore = Object.keys(userData.quizHistory).length * 50;
            let totalScore = (userData.visitedIds.length * 50) + quizScore;
            document.getElementById('score-val').innerText = totalScore;
            document.getElementById('collection-score-val').innerText = totalScore;
        }

        // --- ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜/èª­è¾¼ ---
        async function cloudSave() {
            const email = document.getElementById('cloud-email').value;
            const pass = document.getElementById('cloud-pass').value;
            if(!email || !pass) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            showLoading(true);
            const res = await callGasApi({
                action: 'saveUser',
                email: email, password: pass, saveData: userData
            }, true);
            showLoading(false);
            if(res) alert(res.msg);
        }

        async function cloudLoad() {
            const email = document.getElementById('cloud-email').value;
            const pass = document.getElementById('cloud-pass').value;
            if(!email || !pass) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");

            showLoading(true);
            const res = await callGasApi({ action: 'loadUser', email: email, password: pass });
            showLoading(false);
            
            if(res && res.success) {
                if(res.data) userData = res.data;
                localStorage.setItem('localSaveData', JSON.stringify(userData));
                updateScore();
                alert("èª­ã¿è¾¼ã¿å®Œäº†");
                goTitle();
            } else {
                alert(res ? res.msg : "ã‚¨ãƒ©ãƒ¼");
            }
        }

        function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }

        // --- ã‚¹ãƒãƒƒãƒˆä¿å­˜ãƒ»å‰Šé™¤ (API) ---
        async function saveSpot() {
            const name = document.getElementById('ed-name').value;
            if(!name) return alert("åå‰å¿…é ˆ");
            
            const desc = document.getElementById('ed-desc').value;
            const imgRaw = document.getElementById('ed-imgs').value;
            const images = imgRaw.split('\n').map(u=>u.trim()).filter(u=>u.length>0);
            const tagRaw = document.getElementById('ed-tags').value;
            const tags = tagRaw.split(',').map(t=>t.trim()).filter(t=>t.length>0);
            const timestamp = Date.now();

            const newSpot = {
                id: (editingIndex >= 0) ? spots[editingIndex].id : Date.now(),
                lat: (editingIndex >= 0) ? spots[editingIndex].lat : parseFloat(document.getElementById('edit-modal').dataset.lat),
                lng: (editingIndex >= 0) ? spots[editingIndex].lng : parseFloat(document.getElementById('edit-modal').dataset.lng),
                name: name, desc: desc, images: images, tags: tags,
                quizzes: editingSpotQuizzes, lastUpdated: timestamp
            };

            showLoading(true);
            const res = await callGasApi({ action: 'saveSpot', spotData: newSpot, isDelete: false }, true);
            
            if(res && res.success) {
                closeModal('edit-modal');
                const spotRes = await callGasApi({ action: 'getAllSpots' });
                if(spotRes) spots = spotRes;
                refreshMarkers();
            }
            showLoading(false);
            if(res) alert(res.msg);
        }

        async function deleteSpot() {
            if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const spotId = spots[editingIndex].id;
            showLoading(true);
            const res = await callGasApi({ action: 'saveSpot', spotData: {id: spotId}, isDelete: true }, true);
            if(res && res.success) {
                closeModal('edit-modal');
                const spotRes = await callGasApi({ action: 'getAllSpots' });
                if(spotRes) spots = spotRes;
                refreshMarkers();
            }
            showLoading(false);
            if(res) alert(res.msg);
        }

        // --- UIãƒ­ã‚¸ãƒƒã‚¯ ---
        function switchScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen')); document.getElementById(id).classList.add('active-screen'); }
        function goTitle() { switchScreen('title-screen'); }
        function showCloudScreen() { switchScreen('cloud-screen'); }
        
        function startGame(role) {
            currentRole = role; document.body.className = ''; if(role !== 'player') document.body.classList.add('mode-'+role);
            switchScreen('game-screen'); isTracking = true; updateJumpBtnDesign();
            if(!map) setTimeout(initMap, 100); else { map.invalidateSize(); refreshMarkers(); if(userLat!==0) map.setView([userLat, userLng], 17); }
        }
        function requestAdminLogin() {
            let p = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(0000: ç®¡ç†è€…, 1111: ç·¨é›†è€…)");
            if(p === "0000") startGame('admin'); else if(p === "1111") startGame('editor'); else if(p) alert("é•ã„ã¾ã™");
        }

        function initMap() {
            map = L.map('map').setView([35.6812, 139.7671], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
            userMarker = L.marker([0, 0], { icon: L.divIcon({ className: 'u-icon', html: '<div style="background:#3498db; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow:0 0 5px black;"></div>', iconSize: [24, 24] }) }).addTo(map);
            map.on('dragstart', () => { if(isTracking) { isTracking = false; updateJumpBtnDesign(); } });
            map.on('click', (e) => {
                if(currentRole === 'player') return;
                editingIndex = -1; document.getElementById('ed-name').value = ""; document.getElementById('ed-desc').value = ""; document.getElementById('ed-imgs').value = ""; document.getElementById('ed-tags').value = ""; editingSpotQuizzes = [];
                document.getElementById('del-btn').style.display = 'none';
                document.getElementById('edit-modal').dataset.lat = e.latlng.lat; document.getElementById('edit-modal').dataset.lng = e.latlng.lng;
                document.getElementById('edit-modal').style.display = 'flex';
            });
            navigator.geolocation.watchPosition((pos) => {
                userLat = pos.coords.latitude; userLng = pos.coords.longitude; userMarker.setLatLng([userLat, userLng]);
                if(isTracking) map.setView([userLat, userLng], map.getZoom()); checkProximity();
            }, (e) => console.log(e), { enableHighAccuracy: true });
            refreshMarkers();
        }
        function jumpToUser() { if(userLat !== 0) { isTracking = true; updateJumpBtnDesign(); map.setView([userLat, userLng], 17); } else alert("GPSå–å¾—ä¸­..."); }
        function updateJumpBtnDesign() { const btn = document.getElementById('jump-btn'); if(isTracking) { btn.classList.add('tracking'); btn.innerText = "ç¾åœ¨åœ° (è¿½å°¾ä¸­)"; } else { btn.classList.remove('tracking'); btn.innerText = "ç¾åœ¨åœ°ã¸"; } }

        function refreshMarkers() {
            markers.forEach(m => map.removeLayer(m)); markers = [];
            spots.forEach((spot, index) => {
                const isVisited = userData.visitedIds.includes(spot.id);
                var icon = L.divIcon({ className: 's-icon', html: `<div style="background:${isVisited ? '#f1c40f' : '#2ecc71'}; width:30px; height:30px; border-radius:50%; border:3px solid white; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.3);">${isVisited ? 'â˜…' : '?'}</div>`, iconSize: [36, 36] });
                var m = L.marker([spot.lat, spot.lng], {icon: icon}).addTo(map);
                m.on('click', () => { if(currentRole === 'player') { if(isVisited) showDetail(spot, false, index); else L.popup().setLatLng([spot.lat, spot.lng]).setContent(`<b>${spot.name}</b><br>è¿‘ã¥ã„ã¦ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã—ã‚ˆã†ï¼`).openOn(map); } else showDetail(spot, false, index); });
                markers.push(m);
            });
        }
        function checkProximity() {
            if(currentRole !== 'player') { document.getElementById('checkin-btn').style.display='none'; return; }
            let nearestDist = 99999, nearest = null;
            spots.forEach(spot => { if(userData.visitedIds.includes(spot.id)) return; let d = map.distance([userLat, userLng], [spot.lat, spot.lng]); if(d < nearestDist) { nearestDist = d; nearest = spot; } });
            const btn = document.getElementById('checkin-btn');
            if(nearest && nearestDist < CHECKIN_RANGE) { if(btn.style.display !== 'block') { targetSpot = nearest; btn.style.display = 'block'; } } else { btn.style.display = 'none'; targetSpot = null; }
        }
        
        function showCollection() {
            const list = document.getElementById('collection-list'); list.innerHTML = "";
            if(userData.visitedIds.length === 0) list.innerHTML = "<p style='grid-column:1/-1;text-align:center;'>ã¾ã ä½•ã‚‚è¦‹ã¤ã‘ã¦ã„ã¾ã›ã‚“</p>";
            userData.visitedIds.forEach(vid => {
                const idx = spots.findIndex(s => s.id === vid);
                if(idx >= 0) {
                    const spot = spots[idx]; const div = document.createElement('div'); div.className = 'collection-item'; div.onclick = () => showDetail(spot, false, idx);
                    let imgUrl = 'https://placehold.co/400x300?text=No+Image'; if(spot.images && spot.images.length) imgUrl = formatImgUrl(spot.images[0]); else if(spot.img) imgUrl = formatImgUrl(spot.img);
                    div.innerHTML = `<img src="${imgUrl}" referrerpolicy="no-referrer"><div class="item-name">${spot.name}</div>`; list.appendChild(div);
                }
            });
            switchScreen('collection-screen');
        }
        function openCheckinModal() {
            if(!targetSpot) return; userData.visitedIds.push(targetSpot.id); localStorage.setItem('localSaveData', JSON.stringify(userData)); updateScore();
            const idx = spots.findIndex(s => s.id === targetSpot.id); showDetail(targetSpot, true, idx); document.getElementById('checkin-btn').style.display = 'none'; refreshMarkers();
        }
        function formatImgUrl(url) { if (!url) return ""; let match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if (!match) match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/); if (match && match[1]) return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1000`; return url; }
        
        function showDetail(spot, isReward, index) {
            viewingSpotIndex = index; document.getElementById('det-title').innerText = spot.name; document.getElementById('det-desc').innerText = spot.desc || "";
            const tagsDiv = document.getElementById('det-tags'); tagsDiv.innerHTML = "";
            if(spot.tags) spot.tags.forEach(t => { const s = document.createElement('span'); s.className='tag-badge'; s.innerText=t; tagsDiv.appendChild(s); });
            currentSpotImages = (spot.images && spot.images.length) ? spot.images : (spot.img?[spot.img]:['https://placehold.co/400x300?text=No+Image']); currentImgIndex = 0; updateCarousel();
            document.getElementById('reward-msg').style.display = isReward ? 'block' : 'none'; document.getElementById('detail-box-border').style.borderColor = isReward ? '#ff5252' : '#3498db';

            const quizBtn = document.getElementById('btn-challenge-quiz');
            if(spot.quizzes && spot.quizzes.length > 0) {
                const lastUpdated = spot.lastUpdated || 0; const clearedTime = userData.quizHistory[spot.id] || -1;
                if(lastUpdated > clearedTime) { quizBtn.innerText = "Q. ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ï¼"; quizBtn.className = "btn btn-green"; } else { quizBtn.innerText = "â˜… ã‚¯ã‚¤ã‚ºã‚¯ãƒªã‚¢æ¸ˆã¿"; quizBtn.className = "btn btn-gray"; }
                quizBtn.style.display = 'inline-block';
            } else quizBtn.style.display = 'none';

            const editBtn = document.getElementById('btn-edit-spot');
            editBtn.style.display = (currentRole !== 'player') ? 'inline-block' : 'none';
            document.getElementById('detail-modal').style.display = 'flex';
        }
        function updateCarousel() {
            document.getElementById('det-img').src = formatImgUrl(currentSpotImages[currentImgIndex]); document.getElementById('det-img-count').innerText = `${currentImgIndex+1}/${currentSpotImages.length}`;
            const disp = currentSpotImages.length <= 1 ? 'none' : 'flex'; document.querySelector('.prev-btn').style.display = disp; document.querySelector('.next-btn').style.display = disp; document.getElementById('det-img-count').style.display = currentSpotImages.length <= 1 ? 'none' : 'block';
        }
        function changeSlide(d) { currentImgIndex = (currentImgIndex + d + currentSpotImages.length) % currentSpotImages.length; updateCarousel(); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function triggerEditFromDetail() { closeModal('detail-modal'); openEdit(viewingSpotIndex); }
        function openEdit(index) {
            editingIndex = index; const s = spots[index];
            document.getElementById('ed-name').value = s.name; document.getElementById('ed-desc').value = s.desc||"";
            document.getElementById('ed-imgs').value = (s.images||(s.img?[s.img]:[])).join("\n");
            document.getElementById('ed-tags').value = (s.tags||[]).join(", ");
            editingSpotQuizzes = s.quizzes ? JSON.parse(JSON.stringify(s.quizzes)) : [];
            const canDelete = (currentRole !== 'player'); document.getElementById('del-btn').style.display = canDelete ? 'inline-block' : 'none';
            document.getElementById('edit-modal').style.display = 'flex';
        }
        
        // ã‚¯ã‚¤ã‚º
        function startQuiz() { if(viewingSpotIndex < 0) return; const spot = spots[viewingSpotIndex]; if(!spot.quizzes || !spot.quizzes.length) return; currentQuizList = spot.quizzes; currentQuizIndex = 0; closeModal('detail-modal'); showQuizQuestion(); document.getElementById('quiz-play-modal').style.display = 'flex'; }
        function showQuizQuestion() {
            const quiz = currentQuizList[currentQuizIndex]; document.getElementById('qp-question').innerText = `Q${currentQuizIndex+1}. ${quiz.question}`;
            const choicesDiv = document.getElementById('qp-choices'); choicesDiv.innerHTML = "";
            document.getElementById('qp-result').style.display = 'none'; document.getElementById('qp-next-btn').style.display = 'none'; document.getElementById('qp-retry-btn').style.display = 'none'; document.getElementById('qp-close-btn').style.display = 'none';
            quiz.options.forEach((opt, idx) => { const btn = document.createElement('button'); btn.className = 'quiz-choice-btn'; btn.innerText = opt; btn.onclick = () => answerQuiz(idx); choicesDiv.appendChild(btn); });
        }
        function answerQuiz(idx) {
            const quiz = currentQuizList[currentQuizIndex]; const resDiv = document.getElementById('qp-result'); resDiv.style.display = 'block'; document.querySelectorAll('.quiz-choice-btn').forEach(b => b.disabled = true);
            if(parseInt(idx) === parseInt(quiz.correct)) { resDiv.innerHTML = "<span style='color:red;'>æ­£è§£ï¼</span>"; if(currentQuizIndex < currentQuizList.length - 1) document.getElementById('qp-next-btn').style.display = 'inline-block'; else document.getElementById('qp-close-btn').style.display = 'inline-block'; }
            else { resDiv.innerHTML = `<span style='color:blue;'>æ®‹å¿µ...æ­£è§£ã¯ã€Œ${quiz.options[quiz.correct]}ã€ã§ã—ãŸã€‚</span>`; document.getElementById('qp-retry-btn').style.display = 'inline-block'; }
        }
        function nextQuiz() { currentQuizIndex++; showQuizQuestion(); }
        function retryQuiz() { showQuizQuestion(); }
        function finishQuiz() {
            closeModal('quiz-play-modal'); const spot = spots[viewingSpotIndex]; const lastUpdated = spot.lastUpdated || 0; const clearedTime = userData.quizHistory[spot.id] || -1;
            if(lastUpdated > clearedTime) { alert("ã‚¯ã‚¤ã‚ºã‚¯ãƒªã‚¢ï¼ +50ptï¼"); userData.quizHistory[spot.id] = Date.now(); localStorage.setItem('localSaveData', JSON.stringify(userData)); updateScore(); }
            showDetail(spot, false, viewingSpotIndex);
        }

        // ã‚¯ã‚¤ã‚ºç·¨é›†UI
        function openQuizManager() { document.getElementById('edit-modal').style.display = 'none'; document.getElementById('quiz-manager-modal').style.display = 'flex'; resetQuizForm(); renderQuizList(); }
        function closeQuizManager() { document.getElementById('quiz-manager-modal').style.display = 'none'; document.getElementById('edit-modal').style.display = 'flex'; }
        function renderQuizList() {
            const list = document.getElementById('qm-list'); list.innerHTML = "";
            if(editingSpotQuizzes.length===0) list.innerHTML="<div style='padding:10px;'>ãªã—</div>";
            editingSpotQuizzes.forEach((q,i)=>{
                const div = document.createElement('div'); div.className='quiz-list-item'; div.innerHTML = `<span>Q${i+1}</span>`;
                const editBtn = document.createElement('button'); editBtn.className='quiz-action-btn'; editBtn.innerText="ç·¨é›†"; editBtn.style.background="#f39c12"; editBtn.onclick=()=>editQuiz(i);
                const delBtn = document.createElement('button'); delBtn.className='quiz-action-btn'; delBtn.innerText="å‰Šé™¤"; delBtn.style.background="#ff5252"; delBtn.onclick=()=>{ editingSpotQuizzes.splice(i,1); renderQuizList(); if(quizEditingIndex===i) resetQuizForm(); };
                div.appendChild(editBtn); div.appendChild(delBtn); list.appendChild(div);
            });
        }
        function editQuiz(i) {
            quizEditingIndex=i; const q=editingSpotQuizzes[i]; document.getElementById('qm-q').value=q.question; document.getElementById('qm-a1').value=q.options[0]; document.getElementById('qm-a2').value=q.options[1]; document.getElementById('qm-a3').value=q.options[2]; document.getElementById('qm-correct').value=q.correct;
            document.getElementById('qm-add-btn').innerText="æ›´æ–°"; document.getElementById('qm-cancel-btn').style.display='inline-block';
        }
        function addOrUpdateQuiz() {
            const q=document.getElementById('qm-q').value, a1=document.getElementById('qm-a1').value, a2=document.getElementById('qm-a2').value, a3=document.getElementById('qm-a3').value, c=document.getElementById('qm-correct').value;
            if(!q||!a1||!a2||!a3) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
            const data = { question:q, options:[a1,a2,a3], correct:parseInt(c) };
            if(quizEditingIndex>=0) editingSpotQuizzes[quizEditingIndex]=data; else editingSpotQuizzes.push(data);
            resetQuizForm(); renderQuizList();
        }
        function resetQuizForm() {
            quizEditingIndex=-1; document.getElementById('qm-q').value=""; document.getElementById('qm-a1').value=""; document.getElementById('qm-a2').value=""; document.getElementById('qm-a3').value=""; document.getElementById('qm-correct').value="0";
            document.getElementById('qm-add-btn').innerText="è¿½åŠ "; document.getElementById('qm-cancel-btn').style.display='none';
        }
    </script>
</body>
</html>
