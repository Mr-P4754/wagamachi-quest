<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/3498db/ffffff?text=Q">
    
    <title>ã‚ãŒã¾ã¡ã‚¯ã‚¨ã‚¹ãƒˆV28</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;800&display=swap" rel="stylesheet">

    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body { margin: 0; padding: 0; font-family: 'M PLUS Rounded 1c', sans-serif; background: #fafafa; overflow: hidden; }
        .screen { display: none; width: 100%; height: 100vh; position: absolute; top: 0; left: 0; background: #fff; }
        .active-screen { display: block; }
        #title-screen.active-screen, #cloud-screen.active-screen { display: flex; }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        #loading-overlay { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #ccc; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UIãƒ‘ãƒ¼ãƒ„ */
        .btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: bold; color: white; margin: 5px; cursor: pointer; user-select: none; }
        .btn-blue { background: #3498db; } .btn-red { background: #ff5252; } .btn-gray { background: #7f8c8d; } .btn-orange { background: #f39c12; } .btn-green { background: #27ae60; } .btn-purple { background: #8e44ad; }
        
        /* ãƒãƒƒãƒ—UI (ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«) */
        .map-ctrl-panel { position: absolute; z-index: 1000; background: rgba(255,255,255,0.9); padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; gap: 5px; }
        #filter-ctrl { top: 10px; left: 50%; transform: translateX(-50%); font-size: 12px; white-space: nowrap; overflow-x: auto; max-width: 90%; }
        #style-ctrl { top: 10px; right: 10px; }
        .ctrl-select { padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-size: 12px; }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #map { height: 100%; width: 100%; }
        #back-btn { top: 60px; left: 10px; background: white; padding: 8px 15px; border-radius: 20px; border: 2px solid #ccc; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #score-board { top: 60px; right: 10px; background: #FFD700; color: #d35400; padding: 8px 15px; border-radius: 20px; border: 3px solid white; box-shadow: 0 3px 5px rgba(0,0,0,0.2); }
        #jump-btn { position: absolute; bottom: 30px; right: 20px; z-index: 1000; background: white; padding: 10px 20px; border-radius: 30px; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; color: #333; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        #jump-btn.tracking { background: #e3f2fd; border-color: #2196f3; color: #2196f3; }
        #checkin-btn { display: none; position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 2000; background: #ff5252; color: white; padding: 15px 40px; font-size: 22px; border-radius: 50px; border: 4px solid white; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); animation: bounce 1s infinite; cursor: pointer; font-weight: bold; }
        #admin-settings-btn { display: none; position: absolute; bottom: 100px; right: 20px; z-index: 1000; background: #34495e; color: white; width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 3px 5px rgba(0,0,0,0.3); cursor: pointer; }
        body.mode-admin #admin-settings-btn { display: flex; }
        .ui-float { position: absolute; z-index: 1000; font-weight: bold; text-shadow: 1px 1px 0 #fff; user-select: none; }

        /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
        #title-screen { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        h1 { color: #d35400; font-size: 36px; text-shadow: 3px 3px 0px white; margin-bottom: 10px; line-height: 1.2; }
        #title-score-area { font-size: 18px; font-weight: bold; color: #555; margin-bottom: 20px; background: rgba(255,255,255,0.6); padding: 5px 15px; border-radius: 20px; display: none; }
        .menu-btn { width: 240px; padding: 15px; margin: 10px; font-size: 20px; font-weight: bold; color: white; border: 4px solid white; border-radius: 30px; box-shadow: 0 5px 10px rgba(0,0,0,0.2); cursor: pointer; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); user-select: none; }
        .btn-play { background: #ff9f43; padding: 20px; font-size: 24px; } .btn-collection { background: #1dd1a1; } .btn-cloud { background: #9b59b6; } .btn-admin { background: #8395a7; font-size: 16px; margin-top: 20px; }
        .btn-reset { font-size: 12px; color: #7f8c8d; text-decoration: underline; margin-top: 15px; cursor: pointer; background: none; border: none; }

        /* ã‚¯ãƒ©ã‚¦ãƒ‰ç”»é¢ */
        #cloud-screen { background: #9b59b6; flex-direction: column; align-items: center; justify-content: center; color: white; overflow-y: auto; min-height: 100vh; }
        .cloud-box { background: white; padding: 20px; border-radius: 20px; width: 85%; max-width: 400px; color: #333; text-align: center; margin: 20px 0; }
        .cloud-input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .validation-msg { font-size:11px; color:#e74c3c; text-align:left; margin-bottom:5px; display:block; }

        /* ãšã‹ã‚“ */
        #collection-screen { background: #f0f3f5; overflow-y: auto; }
        #collection-header { background: #1dd1a1; color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .back-home-btn { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: white; color: #1dd1a1; border: none; padding: 5px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; font-weight:bold; }
        #collection-list { padding: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .collection-item { background: white; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 3px 6px rgba(0,0,0,0.1); cursor: pointer; border: 2px solid #fff; }
        .collection-item img { width: 100%; height: 120px; object-fit: cover; border-radius: 10px; background: #eee; margin-bottom: 8px; }
        .item-name { font-size: 14px; font-weight: bold; color: #333; text-align: center; line-height: 1.4; width: 100%; word-wrap: break-word; }

        /* ãƒ¢ãƒ€ãƒ« */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 20px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; border: 5px solid #3498db; max-height: 85vh; overflow-y: auto; position: relative; }
        .input-group label { font-size: 12px; color: #555; display: block; margin-bottom: 4px; text-align: left; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 8px; border: 2px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        
        /* ã„ã„ã­ãƒœã‚¿ãƒ³ */
        .like-btn-area { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 24px; color: #ccc; transition: color 0.2s; }
        .like-btn-area.liked { color: #e74c3c; }
        .like-count { font-size: 14px; color: #555; margin-left: 5px; font-weight: bold; }

        /* ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ãƒ»ã‚¿ã‚°ãªã© */
        .carousel-container { position: relative; width: 100%; height: 220px; margin-bottom: 10px; border-radius: 10px; overflow: hidden; background: #ddd; }
        .carousel-img { width: 100%; height: 100%; object-fit: cover; }
        .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .prev-btn { left: 10px; } .next-btn { right: 10px; }
        .carousel-counter { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .tags-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-bottom: 10px; }
        .tag-badge { background: #e3f2fd; color: #1565c0; font-size: 12px; font-weight: bold; padding: 4px 10px; border-radius: 15px; border: 1px solid #bbdefb; }
        .spot-desc-lg { text-align: left; background: #f9f9f9; padding: 10px; border-radius: 8px; color: #333; margin-bottom: 15px; font-size: 14px; line-height: 1.6; }
        
        .quiz-choice-btn { width: 100%; padding: 15px; margin: 5px 0; background: #fff; border: 2px solid #3498db; color: #3498db; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .quiz-choice-btn:active { background: #e3f2fd; } .quiz-choice-btn:disabled { background: #eee; color: #999; border-color: #ccc; }
        .quiz-list-item { background: #eee; padding: 10px; margin-bottom: 5px; border-radius: 8px; text-align: left; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .quiz-action-btn { padding: 3px 8px; font-size: 10px; margin-left: 2px; border: none; border-radius: 4px; color: white; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="title-screen" class="screen active-screen">
        <h1>ã‚ãŒã¾ã¡<br>ã‚¯ã‚¨ã‚¹ãƒˆ</h1>
        <div id="title-score-area">ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ï¼š<span id="title-score-val">0</span>pt</div>
        <div class="menu-btn btn-play" onclick="startGame('player')">å†’é™ºã«å‡ºã‚‹</div>
        <div class="menu-btn btn-collection" onclick="showCollection()">ãšã‹ã‚“ã‚’è¦‹ã‚‹</div>
        <div class="menu-btn btn-cloud" onclick="showCloudScreen()">ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜/èª­è¾¼</div>
        <div class="menu-btn btn-admin" onclick="requestAdminLogin()">è¨­å®šãƒ»ç·¨é›†</div>
        <button class="btn-reset" onclick="resetLocalData()">ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆã¯ã˜ã‚ã‹ã‚‰ï¼‰</button>
    </div>

    <div id="game-screen" class="screen">
        <div id="map-container" style="width:100%; height:100%;"><div id="map"></div></div>
        
        <div id="filter-ctrl" class="map-ctrl-panel ui-float">
            <select id="tag-filter" class="ctrl-select" onchange="applyFilter()">
                <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
            </select>
        </div>
        <div id="style-ctrl" class="map-ctrl-panel ui-float">
            <select id="map-style" class="ctrl-select" onchange="changeMapStyle()">
                <option value="std">æ¨™æº–</option>
                <option value="sat">èˆªç©ºå†™çœŸ</option>
                <option value="dark">ãƒ€ãƒ¼ã‚¯</option>
            </select>
        </div>

        <div id="back-btn" class="ui-float" onclick="returnToTitle()">ğŸ  ã‚‚ã©ã‚‹</div>
        <div id="score-board" class="ui-float">â˜… <span id="score-val">0</span></div>
        <div id="jump-btn" class="tracking" onclick="jumpToUser()">ç¾åœ¨åœ°ã¸</div>
        <div id="admin-settings-btn" onclick="openAdminSettings()">âš™</div>
        <button id="checkin-btn" onclick="openCheckinModal()">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼</button>
    </div>

    <div id="collection-screen" class="screen">
        <div id="collection-header">
            <button class="back-home-btn" onclick="returnToTitle()">ğŸ </button>
            <div class="header-title">ç™ºè¦‹ã—ãŸã‚¹ãƒãƒƒãƒˆ</div>
            <div class="header-score">ç¾åœ¨ã®ã‚¹ã‚³ã‚¢: <span id="collection-score-val">0</span> pt</div>
        </div>
        <div id="collection-list"></div>
    </div>

    <div id="cloud-screen" class="screen">
        <div class="cloud-box">
            <h2>ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h2>
            <p style="font-size:13px;">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã™ã€‚</p>
            <div style="text-align:left;">
                <label style="font-size:12px;">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
                <input type="text" id="cloud-nick" class="cloud-input" placeholder="10æ–‡å­—ä»¥å†…">
            </div>
            <div style="text-align:left;">
                <label style="font-size:12px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="cloud-pass" class="cloud-input" placeholder="8ã€œ12æ¡ã®åŠè§’è‹±æ•°å­—">
            </div>
            <button class="btn btn-purple" onclick="cloudRegister()">æ–°è¦ç™»éŒ²</button>
            <div style="display:flex; justify-content:center; gap:5px; margin-top:10px;">
                <button class="btn btn-orange" onclick="cloudSave()">ä¿å­˜</button>
                <button class="btn btn-green" onclick="cloudLoad()">èª­è¾¼</button>
            </div>
            <button class="btn btn-blue" style="margin-top:15px; font-size:12px;" onclick="openChangeUserPassModal()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
            <hr>
            <button class="btn btn-gray" style="margin-top:10px;" onclick="returnToTitle()">æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="detail-modal" class="modal-overlay">
        <div class="modal-box" id="detail-box-border">
            <div style="position:relative;">
                <h2 id="det-title" style="margin-top:0; color:#e67e22; padding-right:40px;"></h2>
                <div id="like-btn" class="like-btn-area" onclick="toggleLike()">
                    â¤ <span id="like-count" class="like-count">0</span>
                </div>
            </div>
            <div id="det-tags" class="tags-container"></div>
            <div class="carousel-container">
                <img id="det-img" class="carousel-img" src="" referrerpolicy="no-referrer">
                <button class="carousel-btn prev-btn" onclick="changeSlide(-1)">â®</button>
                <button class="carousel-btn next-btn" onclick="changeSlide(1)">â¯</button>
                <div id="det-img-count" class="carousel-counter">1/1</div>
            </div>
            <div id="det-desc" class="spot-desc-lg"></div>
            <div id="reward-msg" style="display:none; color:#d35400; font-weight:bold; font-size:18px; margin-bottom:10px;">+50ãƒã‚¤ãƒ³ãƒˆ GET!</div>
            <button id="btn-challenge-quiz" class="btn btn-green" style="display:none;" onclick="startQuiz()">Q. ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ï¼</button>
            <button id="btn-edit-spot" class="btn btn-orange" style="display:none;" onclick="triggerEditFromDetail()">âœ ç·¨é›†ã™ã‚‹</button>
            <button class="btn btn-blue" onclick="closeModal('detail-modal')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="quiz-play-modal" class="modal-overlay">
        <div class="modal-box" style="border-color:#27ae60;">
            <h3 style="color:#27ae60;">ã‚¯ã‚¤ã‚ºï¼</h3>
            <p id="qp-question" style="font-weight:bold; font-size:18px; margin:20px 0;"></p>
            <div id="qp-choices"></div>
            <div id="qp-result" style="display:none; font-weight:bold; margin-top:10px; font-size:16px;"></div>
            <button id="qp-next-btn" class="btn btn-blue" style="display:none;" onclick="nextQuiz()">ã¤ãã¸</button>
            <button id="qp-retry-btn" class="btn btn-orange" style="display:none;" onclick="retryQuiz()">ã‚‚ã†ä¸€åº¦</button>
            <button id="qp-close-btn" class="btn btn-gray" style="display:none;" onclick="finishQuiz()">çµ‚äº†</button>
        </div>
    </div>
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-box" style="border-color:#FF9800;">
            <h3>ã‚¹ãƒãƒƒãƒˆç·¨é›†</h3>
            <div class="input-group"><label>åå‰</label><input type="text" id="ed-name"></div>
            <div class="input-group"><label>ã‚¿ã‚°</label><input type="text" id="ed-tags" placeholder="ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š"></div>
            <div class="input-group"><label>èª¬æ˜</label><textarea id="ed-desc"></textarea></div>
            <div class="input-group"><label>å†™çœŸURL</label><textarea id="ed-imgs" style="height:60px;"></textarea></div>
            <div class="hint-text">â€»Googleãƒ‰ãƒ©ã‚¤ãƒ–ã¯ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã€ã«å…¬é–‹</div>
            <button class="btn btn-green" onclick="openQuizManager()">ã‚¯ã‚¤ã‚ºã®ç®¡ç†</button>
            <hr><button class="btn btn-blue" onclick="saveSpot()">ä¿å­˜</button><button id="del-btn" class="btn btn-red" onclick="deleteSpot()">å‰Šé™¤</button><button class="btn btn-gray" onclick="closeModal('edit-modal')">ä¸­æ­¢</button>
        </div>
    </div>
    <div id="quiz-manager-modal" class="modal-overlay">
        <div class="modal-box" style="border-color:#8e44ad; max-width:500px;">
            <h3>ã‚¯ã‚¤ã‚ºã®ç®¡ç†</h3>
            <div id="qm-list" style="max-height:150px; overflow-y:auto; margin-bottom:15px; border:1px solid #ccc;"></div>
            <div style="background:#f9f9f9; padding:10px; border-radius:10px;">
                <div class="input-group"><label>å•é¡Œæ–‡</label><input type="text" id="qm-q"></div>
                <div class="input-group"><label>é¸æŠè‚¢1</label><input type="text" id="qm-a1"></div>
                <div class="input-group"><label>é¸æŠè‚¢2</label><input type="text" id="qm-a2"></div>
                <div class="input-group"><label>é¸æŠè‚¢3</label><input type="text" id="qm-a3"></div>
                <div class="input-group"><label>æ­£è§£</label><select id="qm-correct"><option value="0">é¸æŠè‚¢1</option><option value="1">é¸æŠè‚¢2</option><option value="2">é¸æŠè‚¢3</option></select></div>
                <button id="qm-add-btn" class="btn btn-blue" onclick="addOrUpdateQuiz()">è¿½åŠ </button><button id="qm-cancel-btn" class="btn btn-gray" style="display:none;" onclick="resetQuizForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <button class="btn btn-gray" onclick="closeQuizManager()">æˆ»ã‚‹</button>
        </div>
    </div>
    <div id="admin-settings-modal" class="modal-overlay">
        <div class="modal-box" style="border-color:#34495e;">
            <h3 style="color:#34495e;">ç®¡ç†è€…è¨­å®š</h3>
            <div class="input-group"><label>ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="text" id="new-admin-pass"></div>
            <div class="input-group"><label>ç·¨é›†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="text" id="new-editor-pass"></div>
            <button class="btn btn-orange" onclick="saveNewPasswords()">å¤‰æ›´ã‚’ä¿å­˜</button><hr><button class="btn btn-gray" onclick="closeModal('admin-settings-modal')">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    <div id="user-pass-modal" class="modal-overlay">
        <div class="modal-box" style="border-color:#9b59b6;">
            <h3 style="color:#9b59b6;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
            <div class="input-group"><label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label><input type="text" id="chg-nick" readonly style="background:#eee;"></div>
            <div class="input-group"><label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="chg-old-pass"></div>
            <div class="input-group"><label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="chg-new-pass" placeholder="8ã€œ12æ¡ã®åŠè§’è‹±æ•°å­—"></div>
            <button class="btn btn-orange" onclick="changeUserPassword()">å¤‰æ›´ã™ã‚‹</button><hr><button class="btn btn-gray" onclick="closeModal('user-pass-modal')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // PWA Service Worker ç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // â˜…â˜…â˜… GAS URL (å¤‰æ›´ã—ã¦ãã ã•ã„) â˜…â˜…â˜…
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbylm4K9UHOphbJ4qd7L70pyxP7nnezJe3BJNuX3Kyc7fbbpLHaWBHAVuXdCyAEkBAWtZQ/exec";

        // --- çŠ¶æ…‹ç®¡ç† ---
        let spots = [];
        let userData = { visitedIds: [], quizHistory: {}, nickname: "" }; // nicknameã‚’ä¿æŒ
        let myLikedSpotIds = []; // è‡ªåˆ†ãŒã„ã„ã­ã—ãŸIDãƒªã‚¹ãƒˆ
        let currentRole = 'player';
        let currentPassword = null;
        let map = null, markers = [], userMarker = null, userLat = 0, userLng = 0;
        let isTracking = true, targetSpot = null;
        const CHECKIN_RANGE = 30;
        let tileLayer = null;

        let editingIndex = -1, viewingSpotIndex = -1;
        let currentSpotImages = [], currentImgIndex = 0;
        let editingSpotQuizzes = [], quizEditingIndex = -1;
        let currentQuizList = [], currentQuizIndex = 0;
        const LOCAL_SAVE_KEY = 'localSaveData';

        // --- é€šä¿¡å‡¦ç† ---
        async function callGasApi(params, isPost = false) {
            const url = isPost ? GAS_API_URL : `${GAS_API_URL}?${new URLSearchParams(params)}`;
            const options = isPost ? { method: 'POST', body: JSON.stringify(params) } : { method: 'GET' };
            try { return await (await fetch(url, options)).json(); } catch (e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); return null; }
        }

        // --- èµ·å‹• ---
        window.onload = async function() {
            const localData = localStorage.getItem(LOCAL_SAVE_KEY);
            if(localData) {
                userData = JSON.parse(localData);
                document.getElementById('title-score-area').style.display = 'block';
                // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒã‚ã‚Œã°å…¥åŠ›æ¬„ã«å…¥ã‚Œã¦ãŠã
                if(userData.nickname) document.getElementById('cloud-nick').value = userData.nickname;
            }
            updateScore();

            // ã‚¹ãƒãƒƒãƒˆå–å¾—
            const res = await callGasApi({ action: 'getAllSpots' });
            if(res) { spots = res; updateScore(); updateFilterOptions(); }
            
            // ã„ã„ã­æƒ…å ±å–å¾—
            if(userData.nickname) {
                const likeRes = await callGasApi({ action: 'getMyLikes', nickname: userData.nickname });
                if(likeRes) myLikedSpotIds = likeRes;
            }

            document.getElementById('loading-overlay').style.display = 'none';
        };

        // --- ãƒãƒƒãƒ—ãƒ‡ã‚¶ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ ---
        function changeMapStyle() {
            const style = document.getElementById('map-style').value;
            let url = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'; // æ¨™æº–
            let attr = 'Â© OpenStreetMap';
            
            if (style === 'sat') {
                url = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                attr = 'Tiles Â© Esri';
            } else if (style === 'dark') {
                url = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                attr = 'Â© OpenStreetMap & CartoDB';
            }

            if (tileLayer) map.removeLayer(tileLayer);
            tileLayer = L.tileLayer(url, { attribution: attr }).addTo(map);
        }

        // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ---
        function updateFilterOptions() {
            const select = document.getElementById('tag-filter');
            // ä¸€æ—¦å…¨ã‚¯ãƒªã‚¢
            select.innerHTML = '<option value="all">ã™ã¹ã¦è¡¨ç¤º</option>';
            const allTags = new Set();
            spots.forEach(s => {
                if(s.tags) s.tags.forEach(t => allTags.add(t));
            });
            allTags.forEach(tag => {
                const opt = document.createElement('option');
                opt.value = tag; opt.innerText = tag;
                select.appendChild(opt);
            });
        }

        function applyFilter() {
            refreshMarkers();
        }

        // --- ã„ã„ã­æ©Ÿèƒ½ ---
        async function toggleLike() {
            // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¿…é ˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä»£ã‚ã‚Šï¼‰
            if (!userData.nickname) {
                const input = prompt("ã€Œã„ã„ã­ã€ã™ã‚‹ã«ã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒå¿…è¦ã§ã™ã€‚\nå…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
                if(!input) return;
                userData.nickname = input;
                saveToLocal();
                document.getElementById('cloud-nick').value = input;
            }

            const spot = spots[viewingSpotIndex];
            const btn = document.getElementById('like-btn');
            
            // ä»®æ›´æ–°ï¼ˆUIï¼‰
            const isLiked = btn.classList.contains('liked');
            if(isLiked) {
                btn.classList.remove('liked');
                spot.likeCount--;
                myLikedSpotIds = myLikedSpotIds.filter(id => id != spot.id);
            } else {
                btn.classList.add('liked');
                spot.likeCount++;
                myLikedSpotIds.push(String(spot.id));
            }
            document.getElementById('like-count').innerText = spot.likeCount;

            // ã‚µãƒ¼ãƒãƒ¼é€šä¿¡
            const res = await callGasApi({ action: 'toggleLike', spotId: spot.id, nickname: userData.nickname }, true);
            if(!res || !res.success) {
                alert("ã„ã„ã­ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
                // æˆ»ã™å‡¦ç†ã¯çœç•¥
            }
        }

        // --- é€šå¸¸æ©Ÿèƒ½ ---
        function saveToLocal() { localStorage.setItem(LOCAL_SAVE_KEY, JSON.stringify(userData)); updateScore(); document.getElementById('title-score-area').style.display = 'block'; }
        function resetLocalData() { if(!confirm("ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return; localStorage.removeItem(LOCAL_SAVE_KEY); userData={visitedIds:[],quizHistory:{},nickname:""}; updateScore(); alert("å‰Šé™¤ã—ã¾ã—ãŸ"); location.reload(); }
        function updateScore() { let q=Object.keys(userData.quizHistory).length*50; let t=(userData.visitedIds.length*50)+q; document.getElementById('score-val').innerText=t; document.getElementById('collection-score-val').innerText=t; document.getElementById('title-score-val').innerText=t; }
        function validateInput(n,p) { if(!n||n.length>10){alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 1-10æ–‡å­—");return false;} if(!p||!/^[a-zA-Z0-9]{8,12}$/.test(p)){alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰8-12æ–‡å­—åŠè§’è‹±æ•°");return false;} return true; }
        
        async function cloudRegister() { const n=document.getElementById('cloud-nick').value, p=document.getElementById('cloud-pass').value; if(!validateInput(n,p))return; showLoading(true); const r=await callGasApi({action:'registerUser',nickname:n,password:p,saveData:userData},true); showLoading(false); if(r){ alert(r.msg); if(r.success){ userData.nickname=n; saveToLocal(); }} }
        async function cloudSave() { const n=document.getElementById('cloud-nick').value, p=document.getElementById('cloud-pass').value; if(!n||!p)return alert("å…¥åŠ›å¿…é ˆ"); showLoading(true); const r=await callGasApi({action:'saveUserData',nickname:n,password:p,saveData:userData},true); showLoading(false); if(r){ alert(r.msg); if(r.success){ userData.nickname=n; saveToLocal(); }} }
        async function cloudLoad() { const n=document.getElementById('cloud-nick').value, p=document.getElementById('cloud-pass').value; if(!n||!p)return alert("å…¥åŠ›å¿…é ˆ"); showLoading(true); const r=await callGasApi({action:'loadUserData',nickname:n,password:p},true); showLoading(false); if(r&&r.success){ userData=r.data; userData.nickname=n; saveToLocal(); alert("å®Œäº†"); returnToTitle(); }else alert(r?r.msg:"ã‚¨ãƒ©ãƒ¼"); }
        function openChangeUserPassModal() { const n=document.getElementById('cloud-nick').value; if(!n)return alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›å¿…é ˆ"); document.getElementById('chg-nick').value=n; document.getElementById('user-pass-modal').style.display='flex'; }
        async function changeUserPassword() { const n=document.getElementById('chg-nick').value, o=document.getElementById('chg-old-pass').value, nw=document.getElementById('chg-new-pass').value; if(!o)return alert("æ—§ãƒ‘ã‚¹å…¥åŠ›å¿…é ˆ"); if(!/^[a-zA-Z0-9]{8,12}$/.test(nw))return alert("æ–°ãƒ‘ã‚¹å½¢å¼ã‚¨ãƒ©ãƒ¼"); showLoading(true); const r=await callGasApi({action:'changeUserPassword',nickname:n,oldPassword:o,newPassword:nw},true); showLoading(false); if(r&&r.success){ alert(r.msg); closeModal('user-pass-modal'); document.getElementById('cloud-pass').value=nw; }else alert(r?r.msg:"ã‚¨ãƒ©ãƒ¼"); }
        function showLoading(b) { document.getElementById('loading-overlay').style.display=b?'flex':'none'; }
        
        function switchScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active-screen')); document.getElementById(id).classList.add('active-screen'); }
        function returnToTitle() { switchScreen('title-screen'); }
        function showCloudScreen() { switchScreen('cloud-screen'); }
        function startGame(role) { currentRole=role; document.body.className=''; if(role!=='player') document.body.classList.add('mode-'+role); switchScreen('game-screen'); isTracking=true; updateJumpBtnDesign(); if(!map) setTimeout(initMap,100); else { map.invalidateSize(); refreshMarkers(); if(userLat!==0) map.setView([userLat,userLng], 17); } }
        async function requestAdminLogin() { let p=prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"); if(!p)return; showLoading(true); const r=await callGasApi({action:'loginCheck',password:p},true); showLoading(false); if(r&&r.success){ currentPassword=p; startGame(r.role); }else alert("é•ã„"); }
        function openAdminSettings() { document.getElementById('admin-settings-modal').style.display='flex'; }
        async function saveNewPasswords() { const na=document.getElementById('new-admin-pass').value, ne=document.getElementById('new-editor-pass').value; if(!na||!ne)return alert("å…¥åŠ›å¿…é ˆ"); showLoading(true); const r=await callGasApi({action:'changeAdminPassword',currentAdminPass:currentPassword,newAdminPass:na,newEditorPass:ne},true); showLoading(false); if(r&&r.success){ alert("å¤‰æ›´å®Œäº†"); currentPassword=null; closeModal('admin-settings-modal'); returnToTitle(); }else alert(r?r.msg:"ã‚¨ãƒ©ãƒ¼"); }

        function initMap() { map=L.map('map').setView([35.6812,139.7671],15); changeMapStyle(); userMarker=L.marker([0,0],{icon:L.divIcon({className:'u-icon',html:'<div style="background:#3498db;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 5px black;"></div>',iconSize:[24,24]})}).addTo(map); map.on('dragstart', ()=>{if(isTracking){isTracking=false;updateJumpBtnDesign();}}); map.on('click',(e)=>{if(currentRole==='player')return;editingIndex=-1;document.getElementById('ed-name').value="";document.getElementById('ed-desc').value="";document.getElementById('ed-imgs').value="";document.getElementById('ed-tags').value="";editingSpotQuizzes=[];document.getElementById('del-btn').style.display='none';document.getElementById('edit-modal').dataset.lat=e.latlng.lat;document.getElementById('edit-modal').dataset.lng=e.latlng.lng;document.getElementById('edit-modal').style.display='flex';}); const geo={enableHighAccuracy:true,timeout:10000,maximumAge:0}; navigator.geolocation.watchPosition((pos)=>{userLat=pos.coords.latitude;userLng=pos.coords.longitude;userMarker.setLatLng([userLat,userLng]);if(isTracking)map.setView([userLat,userLng],map.getZoom());checkProximity();},(e)=>{if(e.code===1)alert("ä½ç½®æƒ…å ±è¨±å¯ãŒå¿…è¦");},geo); refreshMarkers(); }
        function jumpToUser() { if(userLat!==0){isTracking=true;updateJumpBtnDesign();map.setView([userLat,userLng],17);}else{alert("GPSå–å¾—ä¸­");navigator.geolocation.getCurrentPosition((p)=>{userLat=p.coords.latitude;userLng=p.coords.longitude;userMarker.setLatLng([userLat,userLng]);isTracking=true;updateJumpBtnDesign();map.setView([userLat,userLng],17);},null,{enableHighAccuracy:true});} }
        function updateJumpBtnDesign() { const b=document.getElementById('jump-btn'); if(isTracking){b.classList.add('tracking');b.innerText="ç¾åœ¨åœ°(è¿½å°¾)";}else{b.classList.remove('tracking');b.innerText="ç¾åœ¨åœ°ã¸";} }
        
        function refreshMarkers() {
            markers.forEach(m=>map.removeLayer(m)); markers=[];
            const filterTag = document.getElementById('tag-filter').value;
            
            spots.forEach((spot, index) => {
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
                if (filterTag !== 'all' && (!spot.tags || !spot.tags.includes(filterTag))) return;

                const isVisited = userData.visitedIds.includes(spot.id);
                var icon = L.divIcon({ className: 's-icon', html: `<div style="background:${isVisited ? '#f1c40f' : '#2ecc71'}; width:30px; height:30px; border-radius:50%; border:3px solid white; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.3);">${isVisited ? 'â˜…' : '?'}</div>`, iconSize: [36, 36] });
                var m = L.marker([spot.lat, spot.lng], {icon: icon}).addTo(map);
                m.on('click', () => { if(currentRole === 'player') { if(isVisited) showDetail(spot, false, index); else L.popup().setLatLng([spot.lat, spot.lng]).setContent(`<b>${spot.name}</b><br>è¿‘ã¥ã„ã¦ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼`).openOn(map); } else showDetail(spot, false, index); });
                markers.push(m);
            });
        }
        function checkProximity() { if(currentRole!=='player'){document.getElementById('checkin-btn').style.display='none';return;} let min=99999, near=null; spots.forEach(s=>{if(userData.visitedIds.includes(s.id))return;let d=map.distance([userLat,userLng],[s.lat,s.lng]);if(d<min){min=d;near=s;}}); const b=document.getElementById('checkin-btn'); if(near&&min<CHECKIN_RANGE){if(b.style.display!=='block'){targetSpot=near;b.style.display='block';}}else{b.style.display='none';targetSpot=null;} }
        function showCollection() { const l=document.getElementById('collection-list'); l.innerHTML=""; if(userData.visitedIds.length===0)l.innerHTML="<p style='grid-column:1/-1;text-align:center;'>ãªã—</p>"; userData.visitedIds.forEach(v=>{ const i=spots.findIndex(s=>s.id===v); if(i>=0){ const s=spots[i], d=document.createElement('div'); d.className='collection-item'; d.onclick=()=>showDetail(s,false,i); let u='https://placehold.co/400x300?text=No+Image'; if(s.images&&s.images.length)u=formatImgUrl(s.images[0]); else if(s.img)u=formatImgUrl(s.img); d.innerHTML=`<img src="${u}" referrerpolicy="no-referrer"><div class="item-name">${s.name}</div>`; l.appendChild(d); } }); switchScreen('collection-screen'); }
        function openCheckinModal() { if(!targetSpot)return; userData.visitedIds.push(targetSpot.id); saveToLocal(); const i=spots.findIndex(s=>s.id===targetSpot.id); showDetail(targetSpot,true,i); document.getElementById('checkin-btn').style.display='none'; refreshMarkers(); }
        function formatImgUrl(u) { if(!u)return ""; let m=u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(!m)m=u.match(/[?&]id=([a-zA-Z0-9_-]+)/); if(m&&m[1])return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w1000`; return u; }
        
        function showDetail(s, r, i) {
            viewingSpotIndex=i; document.getElementById('det-title').innerText=s.name; document.getElementById('det-desc').innerText=s.desc||"";
            
            // ã„ã„ã­ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
            const likeBtn = document.getElementById('like-btn');
            const likeCount = document.getElementById('like-count');
            likeCount.innerText = s.likeCount || 0;
            if (myLikedSpotIds.includes(String(s.id))) likeBtn.classList.add('liked'); else likeBtn.classList.remove('liked');

            const tDiv=document.getElementById('det-tags'); tDiv.innerHTML=""; if(s.tags)s.tags.forEach(t=>{const sp=document.createElement('span');sp.className='tag-badge';sp.innerText=t;tDiv.appendChild(sp);});
            currentSpotImages=(s.images&&s.images.length)?s.images:(s.img?[s.img]:['https://placehold.co/400x300?text=No+Image']); currentImgIndex=0; updateCarousel();
            document.getElementById('reward-msg').style.display=r?'block':'none'; document.getElementById('detail-box-border').style.borderColor=r?'#ff5252':'#3498db';
            const qBtn=document.getElementById('btn-challenge-quiz');
            if(s.quizzes&&s.quizzes.length>0){ const l=s.lastUpdated||0, c=userData.quizHistory[s.id]||-1; if(l>c){qBtn.innerText="Q. ã‚¯ã‚¤ã‚ºæŒ‘æˆ¦";qBtn.className="btn btn-green";}else{qBtn.innerText="â˜…ã‚¯ãƒªã‚¢æ¸ˆ";qBtn.className="btn btn-gray";} qBtn.style.display='inline-block'; } else qBtn.style.display='none';
            document.getElementById('btn-edit-spot').style.display=(currentRole!=='player')?'inline-block':'none';
            document.getElementById('detail-modal').style.display='flex';
        }
        function updateCarousel() { document.getElementById('det-img').src=formatImgUrl(currentSpotImages[currentImgIndex]); document.getElementById('det-img-count').innerText=`${currentImgIndex+1}/${currentSpotImages.length}`; const d=currentSpotImages.length<=1?'none':'flex'; document.querySelector('.prev-btn').style.display=d; document.querySelector('.next-btn').style.display=d; document.getElementById('det-img-count').style.display=currentSpotImages.length<=1?'none':'block'; }
        function changeSlide(d) { currentImgIndex=(currentImgIndex+d+currentSpotImages.length)%currentSpotImages.length; updateCarousel(); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        
        function triggerEditFromDetail() { closeModal('detail-modal'); openEdit(viewingSpotIndex); }
        function openEdit(i) { editingIndex=i; const s=spots[i]; document.getElementById('ed-name').value=s.name; document.getElementById('ed-desc').value=s.desc||""; document.getElementById('ed-imgs').value=(s.images||(s.img?[s.img]:[])).join("\n"); document.getElementById('ed-tags').value=(s.tags||[]).join(","); editingSpotQuizzes=s.quizzes?JSON.parse(JSON.stringify(s.quizzes)):[]; const d=currentRole!=='player'; document.getElementById('del-btn').style.display=d?'inline-block':'none'; document.getElementById('edit-modal').style.display='flex'; }
        async function saveSpot() { const n=document.getElementById('ed-name').value; if(!n)return alert("åå‰å¿…é ˆ"); const s={id:(editingIndex>=0)?spots[editingIndex].id:Date.now(), lat:(editingIndex>=0)?spots[editingIndex].lat:parseFloat(document.getElementById('edit-modal').dataset.lat), lng:(editingIndex>=0)?spots[editingIndex].lng:parseFloat(document.getElementById('edit-modal').dataset.lng), name:n, desc:document.getElementById('ed-desc').value, images:document.getElementById('ed-imgs').value.split('\n').map(u=>u.trim()).filter(u=>u.length), tags:document.getElementById('ed-tags').value.split(',').map(t=>t.trim()).filter(t=>t.length), quizzes:editingSpotQuizzes, lastUpdated:Date.now()}; showLoading(true); const r=await callGasApi({action:'saveSpot',spotData:s,isDelete:false},true); if(r&&r.success){ closeModal('edit-modal'); const rr=await callGasApi({action:'getAllSpots'}); if(rr){spots=rr;updateFilterOptions();refreshMarkers();}} showLoading(false); if(r)alert(r.msg); }
        async function deleteSpot() { if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return; showLoading(true); const r=await callGasApi({action:'saveSpot',spotData:{id:spots[editingIndex].id},isDelete:true},true); if(r&&r.success){ closeModal('edit-modal'); const rr=await callGasApi({action:'getAllSpots'}); if(rr){spots=rr;updateFilterOptions();refreshMarkers();}} showLoading(false); if(r)alert(r.msg); }

        function startQuiz() { if(viewingSpotIndex<0)return; const s=spots[viewingSpotIndex]; if(!s.quizzes||!s.quizzes.length)return; currentQuizList=s.quizzes; currentQuizIndex=0; closeModal('detail-modal'); showQuizQuestion(); document.getElementById('quiz-play-modal').style.display='flex'; }
        function showQuizQuestion() { const q=currentQuizList[currentQuizIndex]; document.getElementById('qp-question').innerText=`Q${currentQuizIndex+1}. ${q.question}`; const d=document.getElementById('qp-choices'); d.innerHTML=""; document.getElementById('qp-result').style.display='none'; document.getElementById('qp-next-btn').style.display='none'; document.getElementById('qp-retry-btn').style.display='none'; document.getElementById('qp-close-btn').style.display='none'; q.options.forEach((o,i)=>{const b=document.createElement('button');b.className='quiz-choice-btn';b.innerText=o;b.onclick=()=>answerQuiz(i);d.appendChild(b);}); }
        function answerQuiz(i) { const q=currentQuizList[currentQuizIndex], r=document.getElementById('qp-result'); r.style.display='block'; document.querySelectorAll('.quiz-choice-btn').forEach(b=>b.disabled=true); if(parseInt(i)===parseInt(q.correct)){ r.innerHTML="<span style='color:red;'>æ­£è§£ï¼</span>"; if(currentQuizIndex<currentQuizList.length-1)document.getElementById('qp-next-btn').style.display='inline-block'; else document.getElementById('qp-close-btn').style.display='inline-block'; }else{ r.innerHTML=`<span style='color:blue;'>ä¸æ­£è§£...æ­£è§£: ${q.options[q.correct]}</span>`; document.getElementById('qp-retry-btn').style.display='inline-block'; } }
        function nextQuiz() { currentQuizIndex++; showQuizQuestion(); }
        function retryQuiz() { showQuizQuestion(); }
        function finishQuiz() { closeModal('quiz-play-modal'); const s=spots[viewingSpotIndex], l=s.lastUpdated||0, c=userData.quizHistory[s.id]||-1; if(l>c){ alert("ã‚¯ãƒªã‚¢! +50pt"); userData.quizHistory[s.id]=Date.now(); saveToLocal(); } showDetail(s,false,viewingSpotIndex); }
        
        function openQuizManager() { document.getElementById('edit-modal').style.display='none'; document.getElementById('quiz-manager-modal').style.display='flex'; resetQuizForm(); renderQuizList(); }
        function closeQuizManager() { document.getElementById('quiz-manager-modal').style.display='none'; document.getElementById('edit-modal').style.display='flex'; }
        function renderQuizList() { const l=document.getElementById('qm-list'); l.innerHTML=""; if(editingSpotQuizzes.length===0)l.innerHTML="ãªã—"; editingSpotQuizzes.forEach((q,i)=>{const d=document.createElement('div');d.className='quiz-list-item';d.innerHTML=`<span>Q${i+1}</span>`;const e=document.createElement('button');e.className='quiz-action-btn';e.innerText="ç·¨é›†";e.style.background="#f39c12";e.onclick=()=>editQuiz(i);const r=document.createElement('button');r.className='quiz-action-btn';r.innerText="å‰Šé™¤";r.style.background="#ff5252";r.onclick=()=>{editingSpotQuizzes.splice(i,1);renderQuizList();if(quizEditingIndex===i)resetQuizForm();};d.appendChild(e);d.appendChild(r);l.appendChild(d);}); }
        function editQuiz(i) { quizEditingIndex=i; const q=editingSpotQuizzes[i]; document.getElementById('qm-q').value=q.question; document.getElementById('qm-a1').value=q.options[0]; document.getElementById('qm-a2').value=q.options[1]; document.getElementById('qm-a3').value=q.options[2]; document.getElementById('qm-correct').value=q.correct; document.getElementById('qm-add-btn').innerText="æ›´æ–°"; document.getElementById('qm-cancel-btn').style.display='inline-block'; }
        function addOrUpdateQuiz() { const q=document.getElementById('qm-q').value, a1=document.getElementById('qm-a1').value, a2=document.getElementById('qm-a2').value, a3=document.getElementById('qm-a3').value, c=document.getElementById('qm-correct').value; if(!q||!a1||!a2||!a3)return alert("å…¥åŠ›å¿…é ˆ"); const d={question:q,options:[a1,a2,a3],correct:parseInt(c)}; if(quizEditingIndex>=0)editingSpotQuizzes[quizEditingIndex]=d; else editingSpotQuizzes.push(d); resetQuizForm(); renderQuizList(); }
        function resetQuizForm() { quizEditingIndex=-1; document.getElementById('qm-q').value=""; document.getElementById('qm-a1').value=""; document.getElementById('qm-a2').value=""; document.getElementById('qm-a3').value=""; document.getElementById('qm-correct').value="0"; document.getElementById('qm-add-btn').innerText="è¿½åŠ "; document.getElementById('qm-cancel-btn').style.display='none'; }
    </script>
</body>
</html>
